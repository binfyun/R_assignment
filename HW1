---
title: "Homework 1: Insights on Poverty"
date: "February 4, 2016"
output: html_document
---
 
**This homework is due Sunday February 14, 2016 at 11:59 PM. When complete, submit your code in the R Markdown file and the knitted HTML file on Canvas.**


# Background

This HW is based on Hans Rosling talks [New Insights on Poverty](https://www.ted.com/talks/hans_rosling_reveals_new_insights_on_poverty?language=en) and [The Best Stats You've Ever Seen](https://www.ted.com/talks/hans_rosling_shows_the_best_stats_you_ve_ever_seen). 

The assignment uses data to answer specific question about global health and economics. The data contradicts commonly held preconceived notions. For example, Hans Rosling starts his talk by asking: (paraphrased) "for each of the six pairs of countries below, which country do you think had the highest child mortality in 2015?" 

1. Sri Lanka or Turkey
2. Poland or South Korea
3. Malaysia or Russia
4. Pakistan or Vietnam
5. Thailand or South Africa

Most people get them wrong. Why is this? In part it is due to our preconceived notion that the world is divided into two groups: the
_Western world_ versus the _third world_, characterized by "long life,small family" and "short life, large family" respectively. In this homework we will use data visualization to gain insights on this topic.  


# Problem 1

The first step in our analysis is to download and organize the data. The necessary data to answer these question is available on the [gapminder](http://www.gapminder.org/data/) website. 

## Problem 1.1

We will use the following datasets:

1.     [Childhood mortality](http://spreadsheets.google.com/pub?key=0ArfEDsV3bBwCcGhBd2NOQVZ1eWowNVpSNjl1c3lRSWc&output=csv)
2.     [Life expectancy](http://spreadsheets.google.com/pub?key=phAwcNAVuyj2tPLxKvvnNPA&output=csv)
3.     [Fertility](http://spreadsheets.google.com/pub?key=phAwcNAVuyj0TAlJeCEzcGQ&output=csv)
4.     [Population](http://spreadsheets.google.com/pub?key=phAwcNAVuyj0XOoBL_n5tAQ&output=csv)
5.     [Total GDP](http://spreadsheets.google.com/pub?key=pyj6tScZqmEfI4sLVvEQtHw&output=csv)

Create five `tbl_df` table objects, one for each of the tables provided in the above files. Hints: Use the `read_csv` function. Because these are only temporary files, give them short names.
```{r,include=FALSE}
library(devtools)
library(dplyr)
library(readr)
library(tidyr)
library(gapminder)
library(ggplot2)
library(ggrepel)

mo5 <- read_csv("/Users/davidlin/R/indicator gapminder under5mortality - Data.csv")
life <- read_csv("/Users/davidlin/R/indicator life_expectancy_at_birth - Data.csv")
fer <- read_csv("/Users/davidlin/R/indicator undata total_fertility - Data.csv")
pop <- read_csv("/Users/davidlin/R/indicator gapminder population - Data.csv")
GDP <- read_csv("/Users/davidlin/R/indicator GDP at market prices, constant 2000 US$ (WB estimates) .xls - Data.csv")




```


## Problem 1.2

 Write a function called `my_func` that takes a table as an argument and returns the column name. For each of the five tables, what is the name of the column containing the country names? Print out the tables or look at them with `View` to determine the column.

```{r}
my_func <- function(x){
    names <- colnames(x)
    col_1 <- names[1]
return(col_1)
}
my_func(mo5)
my_func(GDP)
my_func(fer)
my_func(pop)
my_func(life)

```

## Problem 1.3 

In the previous problem we noted that gapminder is inconsistent in naming their country column. Fix this by assigning a common name to this column in the various tables.

```{r}
mo5_new <- rename(mo5, country=`Under five mortality`)
GDP_new <- rename(GDP, country=`GDP (constant 2000 US$)`)
fer_new <- rename(fer, country=`Total fertility rate`)
pop_new <- rename(pop, country=`Total population`)
life_new <- rename(life, country=`Life expectancy with projections. Yellow is IHME`)
```

## Problem 1.4 

Notice that in these tables, years are represented by columns. We want to create a tidy dataset in which each row is a unit or observation and our 5 values of interest, including the year for that unit, are in the columns. The unit here is a country/year pair and each unit gets values:

```{r}
life_gather <- gather(life_new, key=year, value=Life_exp, 2:217)

```

We call this the _long_ format. Use the `gather` function from the `tidyr` package to create a new table for childhood mortality using the long format. Call the new columns `year` and `child_mortality`

```{r}
mo5_gather <- gather(mo5_new, key=year, value=Child_mortality, 2:217)
```

Now redefine the remaining tables in this way.

```{r}
GDP_gather <- gather(GDP_new, key=year, value=GDP, 2:53)
fer_gather <- gather(fer_new, key=year, value=Fertility, 2:217)
pop_gather <- gather(pop_new, key=year, value=Population, 2:82)
```


## Problem 1.5

Now we want to join all these files together. Make one consolidated table containing all the columns

```{r}
agre_datat <- Reduce(function(x, y) merge(x, y, all=TRUE), list(life_gather, mo5_gather, GDP_gather, fer_gather, pop_gather))
```

## Problem 1.6

Add a column to the consolidated table containing the continent for each country. Hint: We have created a file that maps countries to continents [here](https://github.com/datasciencelabs/data/blob/master/homework_data/continent-info.tsv). Hint: Learn to use the `left_join` function.

```{r}
conti <- read_tsv("https://raw.githubusercontent.com/datasciencelabs/data/master/homework_data/continent-info.tsv", col_names = FALSE)
agre_datat_conti <- left_join(agre_datat, conti, by=c("country"="X1"))
```

# Problem 2 

Report the child mortalilty rate in 2015 for these 5 pairs:

1. Sri Lanka or Turkey
2. Poland or South Korea
3. Malaysia or Russia
4. Pakistan or Vietnam
5. Thailand or South Africa

```{r}
filter(agre_datat_conti, year==2015) %>% filter(country=="Sri Lanka"|country=="Turkey")
filter(agre_datat_conti, year==2015) %>% filter(country=="Polond"|country=="South Korea")
filter(agre_datat_conti, year==2015) %>% filter(country=="Malaysia"|country=="Russia")
filter(agre_datat_conti, year==2015) %>% filter(country=="Pakistan"|country=="Vietnam")
filter(agre_datat_conti, year==2015) %>% filter(country=="Sri Lanka"|country=="South Africa")
```

# Problem 3

To examine if in fact there was a long-life-in-a-small-family and short-life-in-a-large-family dichotomy,  we will visualize the average number of children per family (fertility) and the life expectancy for each country.

## Problem 3.1 

Use `ggplot2` to create a plot of life expectancy versus fertiltiy for 1962 for Africa, Asia, Europe, and the Americas. Use color to denote continent and point size to denote population size:

```{r}
africa_1962_life_fer <- filter(agre_datat_conti, year==1962) %>% filter(X2=="Africa"|X2=="Asia" | X2=="Europe"| X2=="Americas")
africa_1962_life_fer <- rename(africa_1962_life_fer, Continent=X2)
p <- ggplot(africa_1962_life_fer, aes(x= Life_exp, y=Fertility)) + geom_point(aes(color=Continent, size=Population))
p
```

Do you see a dichotomy? Explain.

**Continents with lower life expectancy produce more offsprings than continents with higher life expetency.** 

## Problem 3.2

Now we will annotate the plot to show different types of countries. 

Learn about OECD and OPEC. Add a couple of columns to your consolidated tables containing a logical vector that tells if a country is OECD and OPEC respectively. It is ok to base membership on 2015.

```{r}

OPEC_OECD <- read_csv("../Documents/OECD_OPEC.csv")
africa_1962_life_fer_mem <- left_join(africa_1962_life_fer, OPEC_OECD, by="country")
##View(africa_1962_life_fer_mem)

###OECD <- read_csv("../Documents/OECD.csv")
###OECD_country <- OECD$country
###africa_1962_life_fer_OPEC_OECD <- mutate(africa_1962_life_fer_member, Memberships = ###ifelse(africa_1962_life_fer_member$country %in% OECD_country, "OECD", NA))


```

### Problem 3.3

Make the same plot as in Problem 3.1, but this time use color to annotate the OECD countries and OPEC countries. For countries that are not part of these two organization annotate if they are from Africa, Asia, or the Americas.

```{r}
p <- ggplot(africa_1962_life_fer_mem, aes(x= Life_exp, y=Fertility)) + geom_point(aes(color=membership, size=Population)) + geom_text_repel(aes(label=ifelse(Continent %in% c("Africa","Asia","Americas"), Continent, NA)))
p
```

How would you describe the dichotomy?
**Most of countries from OECD enjoy high life expectancy while virtually all OPEC member countries suffer lower life expectancy. Almost all countries in Africa and many countries in Asia produce more offsprings while suffers lowest life expectancy**

### Problem 3.4

Explore how this figure changes across time. Show us 4 figures that demonstrate how this figure changes through time.

```{r}
years <- c(1962,1982,2002,2015)
africa_chrono_life_fer <- filter(agre_datat_conti, year %in% years) %>% filter(X2=="Africa"|X2=="Asia" | X2=="Europe"| X2=="Americas")
africa_chrono_life_fer <- rename(africa_chrono_life_fer, Continent=X2)

OPEC_OECD <- read_csv("../Documents/OECD_OPEC.csv")
africa_chrono_life_fer_mem <- left_join(africa_chrono_life_fer, OPEC_OECD, by="country")
##View(africa_chrono_life_fer_mem)

p <- ggplot(filter(africa_chrono_life_fer_mem, year==2015), aes(x= Life_exp, y=Fertility)) + geom_point(aes(color=membership, size=Population)) + geom_text_repel(aes(label=ifelse(Continent %in% c("Africa","Asia","Americas"), Continent, NA)))
p
```

Would you say that the same dichotomy exists today? Explain:

**From the plot, while many African countries still suffer very low life expectancy, virtually all asian countries and OPEC member countries have joined OECD members to becom the contires with the higheset life expectancy. Thus, I would say the same dichotomy does not exist today **

## Problem 3.5 (Optional)

Make an animation with the `gganimate` package.

```{r, eval=FALSE}
library(gganimate)
theme_set(theme_bw())

p <- ggplot(africa_chrono_life_fer_mem, aes(x= Life_exp, y=Fertility, size = Population, color = membership, frame = year)) + geom_point() + geom_text_repel(aes(label=ifelse(Continent %in% c("Africa","Asia","Americas"), Continent, NA)))
gg_animate(p)
```


# Problem 4 
Having time as a third dimension made it somewhat difficult to see specific country trends. Let's now focus on specific countries.

## Problem 4.1
Let's compare France and its former colony Tunisia. Make a plot of fertility versus year with color denoting the country. Do the same for life expecancy. How would you compare Tunisia's improvement compared to France's in the past 60 years? Hint: use `geom_line`

**Tunisia have cathched up with France in terms of longer life expectancy but dropped sharply in fertility** 
```{r}
countries <- c("France","Tunisia")
years <- seq(1955,2015,10)
agre_datat_conti <- rename(agre_datat_conti, Continent=X2)
France_Tunisia <- filter(agre_datat_conti, country %in% countries)
France_Tunisia_60yrs <- filter(France_Tunisia, year %in% years)
France_Tunisia_60yrs <- mutate(France_Tunisia_60yrs, YEAR=as.numeric(year))
p1 <- ggplot(France_Tunisia_60yrs, aes(x=YEAR,y=Fertility, size=Population, color=country)) + geom_line()
p1

p2 <- ggplot(France_Tunisia_60yrs, aes(x=YEAR,y=Life_exp, size=Population, color=country)) + geom_line()
p2

```

## Problem 4.2

Do the same, but this time compare Vietnam to the OECD countries.

**For the past 60 years, Vietnam have improved significantly in its life expetancy, although also seen a sharp drop in fertility. The majority of OECD member countries started out with higher life expetancy and countinue to improve years onward, however there are gradual drop in fertility.**
```{r}
all_years_member_conti <- left_join(agre_datat_conti, OPEC_OECD, by="country")
Viet_OECD <- filter(all_years_member_conti, country=="Vietnam" | membership=="OECD")
Viet_OECD_60yrs <- filter(Viet_OECD, year %in% years)
Viet_OECD_60yrs <- mutate(Viet_OECD_60yrs, YEAR=as.numeric(year))

p1 <- ggplot(Viet_OECD_60yrs, aes(x=YEAR,y=Fertility)) + geom_line(aes(color=country)) +geom_text_repel(aes(label=ifelse(country=="Vietnam", country, NA)))
p1

p2 <- ggplot(Viet_OECD_60yrs, aes(x=YEAR,y=Life_exp)) + geom_line(aes(color=country)) +geom_text_repel(aes(label=ifelse(country=="Vietnam", country, NA)))
p2

```


# Problem 5

We are now going to examine GDP per capita per day.

## Problem 5.1

Create a smooth density estimate of the distribution of GDP per capita per day across countries in 1970. Include OECD, OPEC, Asia, Africa, and the Americas in the computation. When doing this we want to weigh countries with larger populations more. We can do this using the "weight"" argument in `geom_density`. 

```{r,warning=FALSE}
conti <- c("Asia","Africa", "Americas")
mem <- c("OPEC","OECD")
all_years_member_conti <- left_join(agre_datat_conti, OPEC_OECD, by="country")
all_coun_member <- filter(all_years_member_conti, Continent %in% conti)

p <- ggplot(filter(all_coun_member, year==1970), aes(x=GDP/360, weight=Population, fill=ifelse(membership %in% mem, membership, Continent))) + geom_density(alpha=.3) + scale_x_log10()
p

```

## Problem 5.2

Now do the same but show each of the five groups separately.

```{r,warning=FALSE}
p1 <- ggplot(filter(all_coun_member, year==1970 & membership=="OPEC"), aes(x=GDP/360, weight=Population)) + geom_density() + ggtitle("OPEC")
##p1
p2 <- ggplot(filter(all_coun_member, year==1970 & membership=="OECD"), aes(x=GDP/360, weight=Population)) + geom_density()+ ggtitle("OECD")
##p2
p3 <- ggplot(filter(all_coun_member, year==1970 & Continent=="Asia"), aes(x=GDP/360, weight=Population)) + geom_density()+ ggtitle("Asia")
##p3
p4 <- ggplot(filter(all_coun_member, year==1970 & Continent=="Africa"), aes(x=GDP/360, weight=Population)) + geom_density()+ ggtitle("Africa")
##p4
p5 <- ggplot(filter(all_coun_member, year==1970 & Continent=="Americas"), aes(x=GDP/360, weight=Population)) + geom_density()+ ggtitle("Americas")
##p5
```
** Using multiplot function from Cookbook for R:**
```{r,echo=FALSE}
multiplot <- function(..., plotlist=NULL, file, cols=1, layout=NULL) {
  library(grid)

  # Make a list from the ... arguments and plotlist
  plots <- c(list(...), plotlist)

  numPlots = length(plots)

  # If layout is NULL, then use 'cols' to determine layout
  if (is.null(layout)) {
    # Make the panel
    # ncol: Number of columns of plots
    # nrow: Number of rows needed, calculated from # of cols
    layout <- matrix(seq(1, cols * ceiling(numPlots/cols)),
                    ncol = cols, nrow = ceiling(numPlots/cols))
  }

 if (numPlots==1) {
    print(plots[[1]])

  } else {
    # Set up the page
    grid.newpage()
    pushViewport(viewport(layout = grid.layout(nrow(layout), ncol(layout))))

    # Make each plot, in the correct location
    for (i in 1:numPlots) {
      # Get the i,j matrix positions of the regions that contain this subplot
      matchidx <- as.data.frame(which(layout == i, arr.ind = TRUE))

      print(plots[[i]], vp = viewport(layout.pos.row = matchidx$row,
                                      layout.pos.col = matchidx$col))
    }
  }
}
```

```{r warning=FALSE}
multiplot(p1, p2, p3, p4, p5, cols=3)

```


## Problem 5.3

Visualize these densities for several years. Show a couple of of them. Summarize how the distribution has changed through the years.

**OECD member countries has the strongest economy througout the years and with more members countinue to becoming top economies, are skewing left. OPEC member countries stay approximately in the middle economies throughout while more African countries have gainin GDPS. Asian countries, with the larest population inthe world, are gaining GDP fast and are quickly catching up with OECD countries.** 

```{r,warning=FALSE}
years <- c("1970","1980","1990","2010","2005")
yr_trend <- filter(all_coun_member, year %in% years) 
p <- ggplot(yr_trend, aes(x=GDP/360, weight=Population, fill=ifelse(membership %in% mem, membership, Continent))) + geom_density(alpha=.3) + scale_x_log10() + facet_grid(.~year)
p

```
